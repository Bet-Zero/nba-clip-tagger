<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Search Clips</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script>
      function toggleSide(event) {
        document
          .querySelectorAll(".toggle-button")
          .forEach((btn) => btn.classList.remove("selected"));
        const btn = event.currentTarget;
        btn.classList.add("selected");
        document.querySelector('input[name="side"]').value = btn.dataset.value;
      }

      function toggleSelectLabel(event) {
        const target = event.currentTarget || event.target;
        target.classList.toggle("selected");
        const field = target.dataset.field;
        const input = document.querySelector(`input[name="${field}"]`);
        const selected = [
          ...document.querySelectorAll(
            `.selectable[data-field="${field}"].selected, .chip[data-field="${field}"].selected`
          ),
        ].map((el) => el.textContent);
        if (input) input.value = selected.join(",");
      }

      function filterList(input) {
        const box = input.closest(".tag-box");
        const container = box.querySelector(".tag-list");
        const query = input.value.toLowerCase();
        const tags = container.querySelectorAll(".selectable");

        tags.forEach((tag) => {
          const text = tag.textContent.toLowerCase();
          tag.style.display = text.includes(query) ? "block" : "none";
        });
      }
    </script>
  </head>
  <body>
    <div class="container">
      <h1>Search Clips</h1>
      <form method="GET" action="/search">
        <div class="form-row">
          <input
            name="player"
            placeholder="Player"
            list="player-list"
            value="{{ args.get('player','') }}"
          />
          <datalist id="player-list">
            {% for p in players %}
            <option value="{{ p }}"></option>
            {% endfor %}
          </datalist>
          <div class="toggle-group">
            <div
              class="toggle-button {% if args.get('side','Offense')=='Offense' %}selected{% endif %}"
              data-value="Offense"
              onclick="toggleSide(event)"
            >
              Offense
            </div>
            <div
              class="toggle-button {% if args.get('side')=='Defense' %}selected{% endif %}"
              data-value="Defense"
              onclick="toggleSide(event)"
            >
              Defense
            </div>
          </div>
          <input
            type="hidden"
            name="side"
            value="{{ args.get('side','Offense') }}"
          />
        </div>
        <div class="form-row">
          <select name="playtype"></select>
          <select name="situation"></select>
        </div>
        <div class="form-row">
          <select name="outcome"></select>
          <select name="context"></select>
        </div>
        <hr class="section-divider" />

        <div class="form-group">
          <label>Traits</label>
          <div class="chip-row" data-field="traits"></div>
          <input
            type="hidden"
            name="traits"
            value="{{ args.get('traits','') }}"
          />
        </div>

        <div id="roles-section" class="tag-section">
          <label>Roles</label>
          <div class="dual-column">
            <div class="column-block">
              <select class="role-select" name="offense_role"></select>
            </div>
            <div class="column-block">
              <select class="role-select" name="defense_role"></select>
            </div>
          </div>
          <input
            type="hidden"
            name="roles"
            value="{{ args.get('roles','') }}"
          />
        </div>

        <details class="subrole-drawer">
          <summary>SubRoles</summary>
          <div id="subroles-section" class="tag-section">
            <div class="dual-column compact-mode">
              <div class="column-block">
                <div class="tag-box">
                  <div class="box-header-row">
                    <span class="box-title">Offense</span>
                    <input
                      type="text"
                      class="filter-input"
                      placeholder="Search..."
                      oninput="filterList(this)"
                    />
                  </div>
                  <div class="tag-list scrollable" data-filter-group></div>
                </div>
              </div>
              <div class="column-block">
                <div class="tag-box">
                  <div class="box-header-row">
                    <span class="box-title">Defense</span>
                    <input
                      type="text"
                      class="filter-input"
                      placeholder="Search..."
                      oninput="filterList(this)"
                    />
                  </div>
                  <div class="tag-list scrollable" data-filter-group></div>
                </div>
              </div>
            </div>
            <input
              type="hidden"
              name="subroles"
              value="{{ args.get('subroles','') }}"
            />
          </div>
        </details>

        <div class="form-group">
          <details class="badge-drawer">
            <summary>Badges</summary>
            <div class="chip-row" data-field="badges"></div>
          </details>
          <input
            type="hidden"
            name="badges"
            value="{{ args.get('badges','') }}"
          />
        </div>

        <button type="submit">üîç Search</button>
      </form>
      {% if results %}
      <hr class="section-divider" />
      <ul class="results">
        {% for r in results %}
        <li title="{{ r.full_path }}">{{ r.label }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    <script src="{{ url_for('static', filename='taggerData.js') }}"></script>
    <script src="{{ url_for('static', filename='search.js') }}"></script>
  </body>
</html>
